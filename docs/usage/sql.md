# {class}`snowmobile.SQL`

{class}`snowmobile.SQL` generates and executes raw SQL based on inputs; 
an instance of {class}`~snowmobile.SQL` is stored as a {class}`~snowmobile.Connector` 
attribute, {attr}`~snowmobile.Connector.sql`, and will execute statements on 
its connection.

Its purpose is to provide a succinct way to execute administrative and 
information-schema-based statements from within Python without embedding SQL in 
docstrings and cluttering code/destroying readability.

{link-badge}`../autoapi/snowmobile/core/sql/index.html,cls=badge-primary text-white,API Reference: snowmobile.core.sql,tooltip=Documentation parsed from module docstring`


```{admonition} Warning
:class: warning

This object should be used thoughtfully; it will not ask twice before dropping 
a {xref}`snowflake` object, and isolated testing to ensure certain methods are 
understood before using them is **strongly** recommended.
```

## **Using** {attr}`~snowmobile.SQL.auto_run`
---

```{admonition} Section Take-Away
:class: note

**The {class}`~snowmobile.SQL` object has an {attr}`~snowmobile.SQL.auto_run` 
attribute which determines whether the SQL generated by a given method is returned 
as a string or executed on the current connection.**

**The default value of the {attr}`~snowmobile.SQL.autorun` is `True`, meaning it 
will execute the generated SQL as opposed to returning it as a string.**

The behavior demonstrated below encompasses all methods of {class}`snowmobile.SQL`, 
not just {meth}`snowmobile.SQL.table_sample`.
```

````{tabbed} Setup

Let's instantiate a {class}`~snowmobile.Connector` object and create a *dummy_table* 
to use for the rest of the example.

Lines 11-12 in the below make use of {class}`snowmobile.Script` to parse a sql 
file containing a single statement and and execute it to keep from cluttering the 
snippet with the full query; the contents of the table created are the only thing 
that matters, but the script is included in the `dummy_table.sql` tab for clarity.

```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 1
:lines: 1-12
```
This creates a temp table for us called `dummy_table` with the following structure:

| SAMPLE\_KEY | SAMPLE\_METRIC1 | SAMPLE\_METRIC2 |
| :--- | :--- | :--- |
| 1 | 1 | 75 |
| 2 | 1 | 11 |
| 3 | 1 | 1 |
| 4 | 2 | 1 |
| 5 | 3 | 55 |
````

````{tabbed} dummy_table.sql

```{literalinclude} ../examples/mod_sql/dummy_table.sql
:language: sql
:lineno-start: 1
:lines: 1-13
```

````

##### 1: When {attr}`~snowmobile.SQL.auto_run`=*True*

By default, calling the  method on our *dummy_table* will execute the generated query
and return the results in a {class}`~pandas.DataFrame`.
```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 16
:lines: 16-19
```

Whether set to *True* or *False*, the behavior imposed by the {attr}`snowmobile.SQL.auto_run` 
can be superseded by the `run` keyword argument provided to any method:
```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 21
:lines: 21-23
```

With the contents of `sample_run_false: str` being:
```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 24
:lines: 24-24
```

    >>>
    select
        *
    from SANDBOX.SAMPLE_TABLE
    limit 5

##### 1: When {attr}`~snowmobile.SQL.auto_run`=*False*

To reverse this behavior, {attr}`~snowmobile.SQL.auto_run` can be set to *False* with:
```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 28
:lines: 28-28
```

With {attr}`~snowmobile.SQL.auto_run` disabled, the *run=False* argument can be 
omitted to produce the same string of sql created on line **21** above:
```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 30
:lines: 30-33
```

To get the {class}`~pandas.DataFrame` created on line **16**, we now need to 
explicitly pass *run=True* to the method:

```{literalinclude} ../examples/mod_sql/sql_working_example.py
:language: python
:lineno-start: 35
:lines: 35-38
```

*The full script for this section can be found* [*here*](../snippets.md#sql_working_examplepy).


## **Using** {attr}`~snowmobile.SQL.nm` **and** {attr}`~snowmobile.SQL.obj`
---

Most {class}`snowmobile.SQL` methods need to know an in-warehouse object's name 
and type (i.e. *dummy_table* and *table* or *sandbox* and *schema*).

These can always be provided as method parameters, but there are times when
setting these values as attributes on the {class}`snowmobile.SQL` object itself can 
minimize a lot of clutter if calling multiple methods on the same in-warehouse  
object within another function or method.


The below is a series of small examples in which the same method is called on two 
instances of {class}`snowmobile.SQL`, one in which these attributes are left as 
defaults, and the other that has had these values explicitly set on it; **note
that each method called on the two instances of {class}`~snowmobile.SQL` 
produce the same results**.

````{tabbed} Setup

The below setup code does the following:
1.  Instantiates two instances of {class}`snowmobile.Connector` with the default 
    set of credentials
1.  Sets the `auto_run` attribute on both instances of 
    {attr}`~snowmobile.Connector.sql` to *False* to omit executing the generated 
    commands throughout example
1.  Creates a **transient** *sample_table* table so that we can 
    access it from either session as if it were a permanent table
1.  Explicitly sets the following on the **second** instances of 
    {class}`~snowmobile.Connector`:
    1.  {attr}`~snowmobile.SQL.nm` to *sample_table*
    1.  {attr}`~snowmobile.SQL.obj` to *table* 

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 1
:lines: 1-17
```

````

From this, the following sets of methods produce **equivalent results**:

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 21
:lines: 21-22
```

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 24
:lines: 24-25
```

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 27
:lines: 27-28
```

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 30
:lines: 30-31
```

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 33
:lines: 33-34
```

```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 36
:lines: 36-37
```

For cleanup, we can drop the `dummy_table` with:
```{literalinclude} ../examples/mod_sql/sql_working_example2.py
:language: python
:lineno-start: 41
:lines: 41-41
```

*The full script for this section can be found* [*here*](../snippets.md#sql_working_example2py).
